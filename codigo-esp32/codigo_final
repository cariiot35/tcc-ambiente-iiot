#include <PubSubClient.h>
#include <WiFi.h>
#include <OneWire.h>
#include <DallasTemperature.h>

// ==================== CONFIG WiFi ====================
const char* ssid = "Teste1";
const char* password = "teste123456";

// ==================== CONFIG MQTT ====================
const char* mqtt_server = "10.88.47.200";  // IP Fedora
const int mqtt_port = 1883;

// ==================== DEFINIÇÃO DE PINOS ==============
#define RELE_BOMBA 12
#define ONE_WIRE_BUS 13
#define SENSOR_NIVEL 14   // FD-10 (digital)

// ==================== VARIÁVEIS ========================
float temperatura = 0.0;
int nivel = 0;

OneWire oneWire(ONE_WIRE_BUS);
DallasTemperature sensors(&oneWire);

WiFiClient espClient;
PubSubClient client(espClient);

// ==================== WiFi =============================
void setup_wifi() {
  Serial.println("\n>>> Conectando ao WiFi...");
  WiFi.begin(ssid, password);

  while (WiFi.status() != WL_CONNECTED) {
    delay(500);
    Serial.print(".");
  }

  Serial.println("\n✅ WiFi conectado!");
  Serial.print("IP do ESP32: ");
  Serial.println(WiFi.localIP());
}

// ==================== MQTT =============================
void reconnect() {
  while (!client.connected()) {
    Serial.print(">>> Conectando ao MQTT Broker...");

    if (client.connect("ESP32_Frigorifico")) {
      Serial.println(" ✅ Conectado!");
    } else {
      Serial.print(" ❌ Falha, rc=");
      Serial.print(client.state());
      Serial.println(" Tentando novamente em 5s...");
      delay(5000);
    }
  }
}

// ==================== SETUP ============================
void setup() {
  Serial.begin(115200);

  sensors.begin();
  pinMode(RELE_BOMBA, OUTPUT);
  pinMode(SENSOR_NIVEL, INPUT);  // FD-10 é digital (HIGH/LOW)

  digitalWrite(RELE_BOMBA, LOW);

  Serial.println("====================================");
  Serial.println("      ESP32 - Sistema Frigorífico   ");
  Serial.println("====================================");

  setup_wifi();
  client.setServer(mqtt_server, mqtt_port);

  Serial.println("✅ Sistema iniciado!");
}

// ==================== LOOP =============================
void loop() {
  // Garantir conexão MQTT
  if (!client.connected()) {
    reconnect();
  }
  client.loop();

  // --- Temperatura ---
  sensors.requestTemperatures();
  float tempC = sensors.getTempCByIndex(0);
  temperatura = (tempC != DEVICE_DISCONNECTED_C) ? tempC : -999;

  // --- Nível FD-10 (digital) ---
  nivel = digitalRead(SENSOR_NIVEL);
  bool agua_presente = (nivel == HIGH);

  // --- Controle da bomba ---
  bool bomba_ligada = false;
  if (temperatura >= 35) {
    digitalWrite(RELE_BOMBA, HIGH);
    bomba_ligada = true;
  } else {
    digitalWrite(RELE_BOMBA, LOW);
    bomba_ligada = false;
  }

  // ==================== MQTT ============================

  // Temperatura
  char temp_msg[16];
  snprintf(temp_msg, sizeof(temp_msg), "%.2f", temperatura);
  client.publish("frigorifico/fisico/temperatura", temp_msg);

  // Nível (0/1)
  char nivel_msg[8];
  snprintf(nivel_msg, sizeof(nivel_msg), "%d", nivel);
  client.publish("frigorifico/fisico/nivel", nivel_msg);

  // Bomba
  client.publish("frigorifico/fisico/bomba", bomba_ligada ? "ON" : "OFF");

  // ==================== LOG =============================
  Serial.println("\n--- DADOS ENVIADOS ---");
  Serial.print("Temperatura: ");
  Serial.print(temperatura);
  Serial.println(" °C");

  Serial.print("Nível FD-10: ");
  Serial.println(agua_presente ? "Água detectada" : "Sem água");

  Serial.print("Bomba: ");
  Serial.println(bomba_ligada ? "LIGADA" : "DESLIGADA");

  delay(5000);  // A cada 5 segundos
}
